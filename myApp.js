"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var parseString = require("xml2js");
var readTextFile = require("read-text-file");
var _ = require("lodash");
var d3Format = require("d3-format");
var d3Dsv = require("d3-dsv");
var fs = require("fs");
var formatter3 = d3Format.format('.3f');
var formatter1 = d3Format.format('.1f');
var PresupuestoAnual = (function () {
    function PresupuestoAnual(xml) {
        var _this = this;
        parseString.parseString(xml, function (err, result) {
            _this.pptoCabecera = result.matriz.cabecera;
            _this.pptoCuerpo = result.matriz.cuerpo;
        });
        this.processCuerpo();
        this.itemsCodigosInstituciones = this.processCabecera();
        this.diccionarioInstituciones = this.buildDiccionarioPartidaCapituloPrograma(this.itemsCodigosInstituciones);
        this.periodo = this.buscarPerido();
        this.addNombresYAño();
    }
    PresupuestoAnual.prototype.processCuerpo = function () {
        this.itemsPresupuesto = _.map(this.pptoCuerpo, function (d) {
            return {
                codPartida: d['CodInstit'][0].substring(0, 2),
                codCapitulo: null,
                codPrograma: null,
                partida: null,
                capitulo: null,
                programa: null,
                asigna: d['asigna'][0],
                codInstit: d['CodInstit'][0],
                item: d['item'][0],
                moneda: d['Moneda'][0],
                montoDolar: d['monto_dolar'][0],
                montoPesos: d['monto_pesos'][0],
                nombreNuevo: d['nombre_nuevo'][0].trim(),
                nSecuencial: d['Nsecuencial'][0],
                numGlosa: d['Num_Glosa'][0],
                subti: d['subti[0]'],
                tipoMov: d['t_tipo_mov[0]'],
                periodo: null,
                nombre: null
            };
        });
    };
    /**
     * Cada item de la cabecera incluye el periodo
     *
     * Vamos a verificar que exista sólo uno y lo almacenamos, de lo contrario retornamos el valor -9999
     *
     * @memberof PresupuestoAnual
     */
    PresupuestoAnual.prototype.buscarPerido = function () {
        var periodos = new Set();
        var periodo = null; // Default
        _.each(this.itemsCodigosInstituciones, function (d) {
            periodos.add(d.periodo);
        });
        if (periodos.size === 1) {
            periodo = +periodos.values().next().value;
        }
        return periodo;
    };
    PresupuestoAnual.prototype.processCabecera = function () {
        // console.dir(result);
        var itemsCodigos = _.map(this.pptoCabecera, function (d) {
            var nombre = d['nombre'][0].trim();
            var periodo = d['periodo'][0];
            var partida = d['partida'][0];
            var capitulo = d['capitulo'][0];
            var programa = d['programa'][0];
            var glosa_Programa = d['glosa_Programa'][0];
            var moneda = d['moneda[0]'];
            var record = {
                nombre: nombre,
                periodo: periodo,
                partida: partida,
                capitulo: capitulo,
                programa: programa,
                glosa_Programa: glosa_Programa,
                moneda: moneda
            };
            return record;
        });
        return itemsCodigos;
    };
    PresupuestoAnual.prototype.buildDiccionarioPartidaCapituloPrograma = function (itemsCodigosInstituciones) {
        var diccionario = {};
        // Agrupamos los códigos por partida
        var partidas = _.groupBy(itemsCodigosInstituciones, function (d) {
            return d.partida;
        });
        _.each(partidas, function (items, partida) {
            // Agrupamos los items de cada partida por capítulo
            var capitulos = _.groupBy(items, function (d) {
                return d.capitulo;
            });
            _.each(capitulos, function (items2, capitulo) {
                // Agrupamos los items de cada caspitulo por programas
                var programas = _.groupBy(items2, function (d) {
                    return d.programa;
                });
                _.each(programas, function (items3, programa) {
                    // Si el item tiene capitulo 00 & programa 00, el nombre corresponde a la partida
                    // Si el item tiene programa 00, el nombre corresponde al capitulo
                    // En si capitulo & programa tienen valores, el nombre corresponde al programa
                    _.each(items3, function (d) {
                        // Partida
                        if (capitulo == '00' && programa == '00') {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].nombre = d.nombre;
                            // Capitulo
                        }
                        else if (programa == '00') {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].capitulos[capitulo] = diccionario[partida].capitulos[capitulo] || { nombre: '', programas: {} };
                            diccionario[partida].capitulos[capitulo].nombre = d.nombre;
                            // Programa
                        }
                        else {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].capitulos[capitulo] = diccionario[partida].capitulos[capitulo] || { nombre: '', programas: {} };
                            diccionario[partida].capitulos[capitulo].programas[programa] =
                                diccionario[partida].capitulos[capitulo].programas[programa] || { nombre: '' };
                            diccionario[partida].capitulos[capitulo].programas[programa].nombre = d.nombre;
                        }
                        //console.log(d.partida, d.capitulo, d.programa, d.nombre);
                    });
                });
            });
        });
        return diccionario;
    };
    PresupuestoAnual.prototype.addNombresYAño = function () {
        var _this = this;
        var itemsPpto = _.groupBy(this.itemsPresupuesto, function (d) {
            return d.codInstit;
        });
        _.each(itemsPpto, function (items, codInstit) {
            var codPartida = codInstit.substring(0, 2);
            var codCapitulo = codInstit.substring(2, 4);
            var codPrograma = codInstit.substring(4, 6);
            var partida = _this.diccionarioInstituciones[codPartida];
            var capitulo = partida.capitulos[codCapitulo];
            var programa = capitulo.programas[codPrograma];
            _.each(items, function (d) {
                d.codPartida = codPartida;
                d.codCapitulo = codCapitulo;
                d.codPrograma = codPrograma;
                d.partida = partida.nombre;
                d.capitulo = capitulo.nombre;
                d.programa = programa.nombre;
                d.periodo = _this.periodo;
            });
        });
    };
    PresupuestoAnual.prototype.tsvFormatted = function () {
        return d3Dsv.tsvFormat(this.itemsPresupuesto);
    };
    return PresupuestoAnual;
}());
var PresupuestoHistorico = (function () {
    function PresupuestoHistorico() {
        this.records = [];
    }
    PresupuestoHistorico.prototype.addTSV = function (tsv) {
        var newrecords = d3Dsv.tsvParse(tsv);
        this.records = this.records.concat(newrecords);
    };
    PresupuestoHistorico.prototype.tsvFormatted = function () {
        var tsv = d3Dsv.tsvFormat(this.records);
        return tsv;
    };
    PresupuestoHistorico.prototype.normaliseNames = function () {
        var _this = this;
        var maxPeriod = _.maxBy(this.records, function (d) { return d.periodo; }).periodo;
        var itemsMaxPeriod = _.filter(this.records, function (d) { return d.periodo == maxPeriod; });
        this.dictionary = new DiccionarioProgramas();
        this.dictionary.buildDictionary(itemsMaxPeriod);
        _.each(this.records, function (d, i) {
            console.log('normalise', Math.floor(100 * i / _this.records.length));
            d.partida = _this.dictionary.getPartida({ codPartida: d.codPartida }) ? _this.dictionary.getPartida({ codPartida: d.codPartida }) : d.partida;
            d.capitulo = _this.dictionary.getCapitulo({ codPartida: d.codPartida, codCapitulo: d.codCapitulo }) ? _this.dictionary.getCapitulo({ codPartida: d.codPartida, codCapitulo: d.codCapitulo }) : d.capitulo;
            d.programa = _this.dictionary.getPrograma({ codPartida: d.codPartida, codCapitulo: d.codCapitulo, codPrograma: d.codPrograma }) ? _this.dictionary.getPrograma({ codPartida: d.codPartida, codCapitulo: d.codCapitulo, codPrograma: d.codPrograma }) : d.programa;
        });
    };
    return PresupuestoHistorico;
}());
var DiccionarioProgramas = (function () {
    function DiccionarioProgramas() {
        this.dictionary = {};
    }
    DiccionarioProgramas.prototype.buildDictionary = function (items) {
        var _this = this;
        var itemsByPartida = _.groupBy(items, function (d) { return d.codPartida; });
        _.each(itemsByPartida, function (itemsCapitulo, codPartida) {
            _this.dictionary[codPartida] = _this.dictionary[codPartida] || { nombre: _.first(itemsCapitulo).partida, capitulos: {} };
            var itemsByCapitulo = _.groupBy(itemsCapitulo, function (d) { return d.codCapitulo; });
            _.each(itemsByCapitulo, function (itemsPrograma, codCapitulo) {
                _this.dictionary[codPartida].capitulos[codCapitulo] = _this.dictionary[codPartida].capitulos[codCapitulo] || { nombre: _.first(itemsPrograma).capitulo, programas: {} };
                var itemsByPrograma = _.groupBy(itemsPrograma, function (d) { return d.codPrograma; });
                _.each(itemsByPrograma, function (itemsAsignacion, codPrograma) {
                    _this.dictionary[codPartida].capitulos[codCapitulo].programas[codPrograma] = _this.dictionary[codPartida].capitulos[codCapitulo].programas[codPrograma] || { nombre: _.first(itemsAsignacion).programa };
                });
            });
        });
    };
    DiccionarioProgramas.prototype.getPartida = function (options) {
        return this.dictionary[options.codPartida] && this.dictionary[options.codPartida].nombre;
    };
    DiccionarioProgramas.prototype.getCapitulo = function (options) {
        return this.dictionary[options.codPartida] && this.dictionary[options.codPartida].capitulos[options.codCapitulo] && this.dictionary[options.codPartida].capitulos[options.codCapitulo].nombre;
    };
    DiccionarioProgramas.prototype.getPrograma = function (options) {
        return this.dictionary[options.codPartida] && this.dictionary[options.codPartida].capitulos[options.codCapitulo] && this.dictionary[options.codPartida].capitulos[options.codCapitulo].programas[options.codPrograma] && this.dictionary[options.codPartida].capitulos[options.codCapitulo].programas[options.codPrograma].nombre;
    };
    return DiccionarioProgramas;
}());
var presupuestoHistorico = new PresupuestoHistorico();
var presupuestoAllYears = '';
_.each(config_1.xmlFiles, function (d, i) {
    console.log(d.periodo);
    var xml = readTextFile.readSync(d.url);
    var presupuesto = new PresupuestoAnual(xml);
    var presupuestoTsv = presupuesto.tsvFormatted();
    fs.writeFile(config_1.outDir + "/presupuesto_" + d.periodo + ".txt", presupuestoTsv, function (err) { console.log(err ? 'Error :' + err : "ok " + d.periodo + ".txt"); });
    presupuestoHistorico.addTSV(presupuestoTsv);
});
presupuestoHistorico.normaliseNames();
fs.writeFile(config_1.outDir + "/presupuesto_allYears.txt", presupuestoHistorico.tsvFormatted(), function (err) { console.log(err ? 'Error :' + err : "ok AllYears.txt"); });

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUEsQ0FBQyxDQUFDLENBQzFFLENBQUMiLCJmaWxlIjoibXlBcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB4bWxGaWxlcywgb3V0RGlyIH0gZnJvbSBcIi4vY29uZmlnXCI7aW1wb3J0ICogYXMgcGFyc2VTdHJpbmcgZnJvbSAneG1sMmpzJztcbmltcG9ydCAqIGFzICByZWFkVGV4dEZpbGUgZnJvbSAncmVhZC10ZXh0LWZpbGUnO1xuaW1wb3J0ICogYXMgIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgIHdyaXRlRmlsZSBmcm9tICd3cml0ZSc7XG5pbXBvcnQgKiBhcyAgZDNGb3JtYXQgZnJvbSAnZDMtZm9ybWF0JztcbmltcG9ydCAqIGFzICBkM0RzdiBmcm9tICdkMy1kc3YnO1xuaW1wb3J0ICogYXMgIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcblxuXG5cbmNvbnN0IGZvcm1hdHRlcjMgPSBkM0Zvcm1hdC5mb3JtYXQoJy4zZicpXG5jb25zdCBmb3JtYXR0ZXIxID0gZDNGb3JtYXQuZm9ybWF0KCcuMWYnKVxuIFxuXG5pbnRlcmZhY2UgSXRlbVByZXN1cHVlc3RvIHtcbiAgICBjb2RQYXJ0aWRhOiBzdHJpbmc7XG4gICAgY29kQ2FwaXR1bG86IHN0cmluZztcbiAgICBjb2RQcm9ncmFtYTogc3RyaW5nO1xuICAgIHBhcnRpZGE6IHN0cmluZztcbiAgICBjYXBpdHVsbzogc3RyaW5nO1xuICAgIHByb2dyYW1hOiBzdHJpbmc7XG4gICAgYXNpZ25hOiBzdHJpbmc7XG4gICAgY29kSW5zdGl0OiBzdHJpbmc7XG4gICAgaXRlbTogc3RyaW5nO1xuICAgIG1vbmVkYTogc3RyaW5nO1xuICAgIG1vbnRvRG9sYXI6IHN0cmluZztcbiAgICBtb250b1Blc29zOiBzdHJpbmc7XG4gICAgbm9tYnJlOiBzdHJpbmc7XG4gICAgblNlY3VlbmNpYWw6IHN0cmluZztcbiAgICBudW1HbG9zYTogc3RyaW5nO1xuICAgIHRpcG9Nb3Y6IHN0cmluZztcbiAgICBwZXJpb2RvOiBudW1iZXI7XG59IFxuXG5cbmNsYXNzIFByZXN1cHVlc3RvQW51YWwge1xuICAgIHBwdG9DYWJlY2VyYTtcbiAgICBwcHRvQ3VlcnBvO1xuICAgIGl0ZW1zUHJlc3VwdWVzdG86IEl0ZW1QcmVzdXB1ZXN0b1tdO1xuICAgIGl0ZW1zQ29kaWdvc0luc3RpdHVjaW9uZXM7XG4gICAgZGljY2lvbmFyaW9JbnN0aXR1Y2lvbmVzO1xuICAgIHBlcmlvZG86IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHhtbCkge1xuICAgICAgICBwYXJzZVN0cmluZy5wYXJzZVN0cmluZyh4bWwsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcHRvQ2FiZWNlcmEgPSByZXN1bHQubWF0cml6LmNhYmVjZXJhO1xuICAgICAgICAgICAgdGhpcy5wcHRvQ3VlcnBvID0gcmVzdWx0Lm1hdHJpei5jdWVycG87XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMucHJvY2Vzc0N1ZXJwbygpO1xuICAgICAgICB0aGlzLml0ZW1zQ29kaWdvc0luc3RpdHVjaW9uZXMgPSB0aGlzLnByb2Nlc3NDYWJlY2VyYSgpO1xuICAgICAgICB0aGlzLmRpY2Npb25hcmlvSW5zdGl0dWNpb25lcyA9IHRoaXMuYnVpbGREaWNjaW9uYXJpb1BhcnRpZGFDYXBpdHVsb1Byb2dyYW1hKHRoaXMuaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcylcbiAgICAgICAgdGhpcy5wZXJpb2RvID0gdGhpcy5idXNjYXJQZXJpZG8oKTtcbiAgICAgICAgdGhpcy5hZGROb21icmVzWUHDsW8oKTtcbiAgICB9XG5cbiAgICBwcm9jZXNzQ3VlcnBvKCkge1xuICAgICAgICB0aGlzLml0ZW1zUHJlc3VwdWVzdG8gPSBfLm1hcCh0aGlzLnBwdG9DdWVycG8sIChkKSA9PiB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiA8SXRlbVByZXN1cHVlc3RvPiB7XG4gICAgICAgICAgICAgICAgY29kUGFydGlkYTogZFsnQ29kSW5zdGl0J11bMF0uc3Vic3RyaW5nKDAsMiksXG4gICAgICAgICAgICAgICAgY29kQ2FwaXR1bG86IG51bGwsXG4gICAgICAgICAgICAgICAgY29kUHJvZ3JhbWE6IG51bGwsXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcGFydGlkYTogbnVsbCxcbiAgICAgICAgICAgICAgICBjYXBpdHVsbzogbnVsbCxcbiAgICAgICAgICAgICAgICBwcm9ncmFtYTogbnVsbCxcblxuICAgICAgICAgICAgICAgIGFzaWduYSA6IGRbJ2FzaWduYSddWzBdLFxuICAgICAgICAgICAgICAgIGNvZEluc3RpdCA6IGRbJ0NvZEluc3RpdCddWzBdLFxuICAgICAgICAgICAgICAgIGl0ZW0gOiBkWydpdGVtJ11bMF0sXG4gICAgICAgICAgICAgICAgbW9uZWRhIDogZFsnTW9uZWRhJ11bMF0sXG4gICAgICAgICAgICAgICAgbW9udG9Eb2xhciA6IGRbJ21vbnRvX2RvbGFyJ11bMF0sXG4gICAgICAgICAgICAgICAgbW9udG9QZXNvcyA6IGRbJ21vbnRvX3Blc29zJ11bMF0sXG4gICAgICAgICAgICAgICAgbm9tYnJlTnVldm8gOiBkWydub21icmVfbnVldm8nXVswXS50cmltKCksXG4gICAgICAgICAgICAgICAgblNlY3VlbmNpYWwgOiBkWydOc2VjdWVuY2lhbCddWzBdLFxuICAgICAgICAgICAgICAgIG51bUdsb3NhIDogZFsnTnVtX0dsb3NhJ11bMF0sXG4gICAgICAgICAgICAgICAgc3VidGkgOiBkWydzdWJ0aVswXSddLFxuICAgICAgICAgICAgICAgIHRpcG9Nb3YgOiBkWyd0X3RpcG9fbW92WzBdJ10sXG4gICAgICAgICAgICAgICAgcGVyaW9kbyA6IG51bGwsXG4gICAgICAgICAgICAgICAgbm9tYnJlOiBudWxsXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FkYSBpdGVtIGRlIGxhIGNhYmVjZXJhIGluY2x1eWUgZWwgcGVyaW9kb1xuICAgICAqIFxuICAgICAqIFZhbW9zIGEgdmVyaWZpY2FyIHF1ZSBleGlzdGEgc8OzbG8gdW5vIHkgbG8gYWxtYWNlbmFtb3MsIGRlIGxvIGNvbnRyYXJpbyByZXRvcm5hbW9zIGVsIHZhbG9yIC05OTk5XG4gICAgICogXG4gICAgICogQG1lbWJlcm9mIFByZXN1cHVlc3RvQW51YWxcbiAgICAgKi9cbiAgICBidXNjYXJQZXJpZG8oKSB7XG4gICAgICAgIGNvbnN0IHBlcmlvZG9zID0gbmV3IFNldCgpO1xuXG4gICAgICAgIGxldCBwZXJpb2RvID0gbnVsbDsgLy8gRGVmYXVsdFxuXG4gICAgICAgIF8uZWFjaCh0aGlzLml0ZW1zQ29kaWdvc0luc3RpdHVjaW9uZXMsIChkKSA9PiB7XG4gICAgICAgICAgICBwZXJpb2Rvcy5hZGQoZC5wZXJpb2RvKVxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChwZXJpb2Rvcy5zaXplID09PSAxKSB7XG4gICAgICAgICAgICBwZXJpb2RvID0gK3BlcmlvZG9zLnZhbHVlcygpLm5leHQoKS52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwZXJpb2RvO1xuXG4gICAgfVxuXG4gICAgcHJvY2Vzc0NhYmVjZXJhKCkge1xuICAgICAgICAvLyBjb25zb2xlLmRpcihyZXN1bHQpO1xuICAgICAgICBjb25zdCBpdGVtc0NvZGlnb3MgPSBfLm1hcCh0aGlzLnBwdG9DYWJlY2VyYSwgKGQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5vbWJyZSA9IGRbJ25vbWJyZSddWzBdLnRyaW0oKTtcbiAgICAgICAgICAgIGNvbnN0IHBlcmlvZG8gPSBkWydwZXJpb2RvJ11bMF07XG4gICAgICAgICAgICBjb25zdCBwYXJ0aWRhID0gZFsncGFydGlkYSddWzBdO1xuICAgICAgICAgICAgY29uc3QgY2FwaXR1bG8gPSBkWydjYXBpdHVsbyddWzBdO1xuICAgICAgICAgICAgY29uc3QgcHJvZ3JhbWEgPSBkWydwcm9ncmFtYSddWzBdO1xuICAgICAgICAgICAgY29uc3QgZ2xvc2FfUHJvZ3JhbWEgPSBkWydnbG9zYV9Qcm9ncmFtYSddWzBdO1xuICAgICAgICAgICAgY29uc3QgbW9uZWRhID0gZFsnbW9uZWRhWzBdJ107XG5cbiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHtcbiAgICAgICAgICAgICAgICBub21icmU6IG5vbWJyZSwgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwZXJpb2RvOiBwZXJpb2RvLCAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcGFydGlkYTogcGFydGlkYSwgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNhcGl0dWxvOiBjYXBpdHVsbywgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwcm9ncmFtYTogcHJvZ3JhbWEsICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGdsb3NhX1Byb2dyYW1hOiBnbG9zYV9Qcm9ncmFtYSwgICAgICAgXG4gICAgICAgICAgICAgICAgbW9uZWRhOiBtb25lZGEgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIGl0ZW1zQ29kaWdvcztcbiAgICB9XG5cbiAgICBidWlsZERpY2Npb25hcmlvUGFydGlkYUNhcGl0dWxvUHJvZ3JhbWEoaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcykge1xuICAgICAgICBjb25zdCBkaWNjaW9uYXJpbyA9IHt9O1xuXG4gICAgICAgIC8vIEFncnVwYW1vcyBsb3MgY8OzZGlnb3MgcG9yIHBhcnRpZGFcbiAgICAgICAgY29uc3QgcGFydGlkYXMgPSBfLmdyb3VwQnkoaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcywgKGQ6SXRlbVByZXN1cHVlc3RvKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZC5wYXJ0aWRhO1xuICAgICAgICB9KVxuXG4gICAgICAgIF8uZWFjaChwYXJ0aWRhcywgKGl0ZW1zLCBwYXJ0aWRhKSA9PiB7XG5cbiAgICAgICAgICAgIC8vIEFncnVwYW1vcyBsb3MgaXRlbXMgZGUgY2FkYSBwYXJ0aWRhIHBvciBjYXDDrXR1bG9cbiAgICAgICAgICAgIGNvbnN0IGNhcGl0dWxvcyA9IF8uZ3JvdXBCeShpdGVtcywgKGQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZC5jYXBpdHVsbztcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBfLmVhY2goY2FwaXR1bG9zLCAoaXRlbXMyLCBjYXBpdHVsbykgPT4ge1xuXG4gICAgICAgICAgICAgICAgLy8gQWdydXBhbW9zIGxvcyBpdGVtcyBkZSBjYWRhIGNhc3BpdHVsbyBwb3IgcHJvZ3JhbWFzXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvZ3JhbWFzID0gXy5ncm91cEJ5KGl0ZW1zMiwgKGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucHJvZ3JhbWE7XG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIF8uZWFjaChwcm9ncmFtYXMsIChpdGVtczMsIHByb2dyYW1hKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gU2kgZWwgaXRlbSB0aWVuZSBjYXBpdHVsbyAwMCAmIHByb2dyYW1hIDAwLCBlbCBub21icmUgY29ycmVzcG9uZGUgYSBsYSBwYXJ0aWRhXG4gICAgICAgICAgICAgICAgICAgIC8vIFNpIGVsIGl0ZW0gdGllbmUgcHJvZ3JhbWEgMDAsIGVsIG5vbWJyZSBjb3JyZXNwb25kZSBhbCBjYXBpdHVsb1xuICAgICAgICAgICAgICAgICAgICAvLyBFbiBzaSBjYXBpdHVsbyAmIHByb2dyYW1hIHRpZW5lbiB2YWxvcmVzLCBlbCBub21icmUgY29ycmVzcG9uZGUgYWwgcHJvZ3JhbWFcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGl0ZW1zMywgKGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBhcnRpZGFcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYXBpdHVsbyA9PSAnMDAnICYmIHByb2dyYW1hID09ICcwMCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXSA9IGRpY2Npb25hcmlvW3BhcnRpZGFdIHx8IHtub21icmU6JycsIGNhcGl0dWxvczp7fX07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljY2lvbmFyaW9bcGFydGlkYV0ubm9tYnJlID0gZC5ub21icmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBDYXBpdHVsb1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9ncmFtYSA9PSAnMDAnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljY2lvbmFyaW9bcGFydGlkYV0gPSBkaWNjaW9uYXJpb1twYXJ0aWRhXSB8fCB7bm9tYnJlOicnLCBjYXBpdHVsb3M6e319O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10gPSBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dIHx8IHtub21icmU6JycsIHByb2dyYW1hczoge319XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljY2lvbmFyaW9bcGFydGlkYV0uY2FwaXR1bG9zW2NhcGl0dWxvXS5ub21icmUgPSBkLm5vbWJyZVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQcm9ncmFtYVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXSA9IGRpY2Npb25hcmlvW3BhcnRpZGFdIHx8IHtub21icmU6JycsIGNhcGl0dWxvczp7fX07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljY2lvbmFyaW9bcGFydGlkYV0uY2FwaXR1bG9zW2NhcGl0dWxvXSA9IGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10gfHwge25vbWJyZTonJywgcHJvZ3JhbWFzOiB7fX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dLnByb2dyYW1hc1twcm9ncmFtYV0gPSBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dLnByb2dyYW1hc1twcm9ncmFtYV0gfHwge25vbWJyZTonJ31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dLnByb2dyYW1hc1twcm9ncmFtYV0ubm9tYnJlID0gZC5ub21icmVcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhkLnBhcnRpZGEsIGQuY2FwaXR1bG8sIGQucHJvZ3JhbWEsIGQubm9tYnJlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pICAgXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZGljY2lvbmFyaW87XG4gICAgfVxuXG4gICAgYWRkTm9tYnJlc1lBw7FvKCkge1xuXG4gICAgICAgIGNvbnN0IGl0ZW1zUHB0byA9IF8uZ3JvdXBCeSh0aGlzLml0ZW1zUHJlc3VwdWVzdG8sIChkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZC5jb2RJbnN0aXQ7XG4gICAgICAgIH0pXG5cbiAgICAgICAgXy5lYWNoKGl0ZW1zUHB0byAsIChpdGVtcywgY29kSW5zdGl0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb2RQYXJ0aWRhPSBjb2RJbnN0aXQuc3Vic3RyaW5nKDAsMik7XG4gICAgICAgICAgICBjb25zdCBjb2RDYXBpdHVsbz0gY29kSW5zdGl0LnN1YnN0cmluZygyLDQpO1xuICAgICAgICAgICAgY29uc3QgY29kUHJvZ3JhbWE9IGNvZEluc3RpdC5zdWJzdHJpbmcoNCw2KTtcblxuICAgICAgICAgICAgY29uc3QgcGFydGlkYSA9IHRoaXMuZGljY2lvbmFyaW9JbnN0aXR1Y2lvbmVzW2NvZFBhcnRpZGFdO1xuICAgICAgICAgICAgY29uc3QgY2FwaXR1bG8gPSBwYXJ0aWRhLmNhcGl0dWxvc1tjb2RDYXBpdHVsb107XG4gICAgICAgICAgICBjb25zdCBwcm9ncmFtYSA9IGNhcGl0dWxvLnByb2dyYW1hc1tjb2RQcm9ncmFtYV07XG5cbiAgICAgICAgICAgIF8uZWFjaChpdGVtcywgKGQpID0+IHtcbiAgICAgICAgICAgICAgICBkLmNvZFBhcnRpZGEgPSBjb2RQYXJ0aWRhO1xuICAgICAgICAgICAgICAgIGQuY29kQ2FwaXR1bG8gPSBjb2RDYXBpdHVsbztcbiAgICAgICAgICAgICAgICBkLmNvZFByb2dyYW1hID0gY29kUHJvZ3JhbWE7ICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZC5wYXJ0aWRhID0gcGFydGlkYS5ub21icmU7XG4gICAgICAgICAgICAgICAgZC5jYXBpdHVsbyA9IGNhcGl0dWxvLm5vbWJyZTtcbiAgICAgICAgICAgICAgICBkLnByb2dyYW1hID0gcHJvZ3JhbWEubm9tYnJlOyAgIFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGQucGVyaW9kbyA9IHRoaXMucGVyaW9kbztcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgdHN2Rm9ybWF0dGVkKCkge1xuICAgICAgICByZXR1cm4gZDNEc3YudHN2Rm9ybWF0KHRoaXMuaXRlbXNQcmVzdXB1ZXN0byk7XG4gICAgfVxufVxuXG5jbGFzcyBQcmVzdXB1ZXN0b0hpc3RvcmljbyB7XG4gICAgcmVjb3JkczogSXRlbVByZXN1cHVlc3RvW10gPSBbXTtcbiAgICBkaWN0aW9uYXJ5OiBEaWNjaW9uYXJpb1Byb2dyYW1hcztcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuXG4gICAgfVxuXG4gICAgYWRkVFNWKHRzdikge1xuICAgICAgICBsZXQgbmV3cmVjb3JkczogYW55W10gPSA8YW55W10+IGQzRHN2LnRzdlBhcnNlKHRzdik7XG4gICAgICAgIHRoaXMucmVjb3JkcyA9IHRoaXMucmVjb3Jkcy5jb25jYXQobmV3cmVjb3Jkcyk7XG4gICAgfVxuXG4gICAgdHN2Rm9ybWF0dGVkKCkge1xuICAgICAgICBsZXQgdHN2ID0gZDNEc3YudHN2Rm9ybWF0KHRoaXMucmVjb3Jkcyk7XG4gICAgICAgIHJldHVybiB0c3Y7XG4gICAgfVxuXG4gICAgbm9ybWFsaXNlTmFtZXMoKSB7XG4gICAgICAgIGNvbnN0IG1heFBlcmlvZCA9IF8ubWF4QnkodGhpcy5yZWNvcmRzLCAoZDpJdGVtUHJlc3VwdWVzdG8pID0+IGQucGVyaW9kbykucGVyaW9kbztcbiAgICAgICAgY29uc3QgaXRlbXNNYXhQZXJpb2QgPSBfLmZpbHRlcih0aGlzLnJlY29yZHMsIChkKSA9PiBkLnBlcmlvZG8gPT0gbWF4UGVyaW9kKTtcblxuICAgICAgICB0aGlzLmRpY3Rpb25hcnkgPSBuZXcgRGljY2lvbmFyaW9Qcm9ncmFtYXMoKTtcbiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5LmJ1aWxkRGljdGlvbmFyeShpdGVtc01heFBlcmlvZCk7XG5cbiAgICAgICAgXy5lYWNoKHRoaXMucmVjb3JkcywgKGQsaSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ25vcm1hbGlzZScsIE1hdGguZmxvb3IoMTAwKmkvdGhpcy5yZWNvcmRzLmxlbmd0aCkpO1xuICAgICAgICAgICAgZC5wYXJ0aWRhID0gdGhpcy5kaWN0aW9uYXJ5LmdldFBhcnRpZGEoe2NvZFBhcnRpZGEgOiBkLmNvZFBhcnRpZGF9KSA/IHRoaXMuZGljdGlvbmFyeS5nZXRQYXJ0aWRhKHtjb2RQYXJ0aWRhIDogZC5jb2RQYXJ0aWRhfSkgOiBkLnBhcnRpZGE7XG4gICAgICAgICAgICBkLmNhcGl0dWxvID0gdGhpcy5kaWN0aW9uYXJ5LmdldENhcGl0dWxvKHtjb2RQYXJ0aWRhIDogZC5jb2RQYXJ0aWRhLCBjb2RDYXBpdHVsbzogZC5jb2RDYXBpdHVsb30pID8gdGhpcy5kaWN0aW9uYXJ5LmdldENhcGl0dWxvKHtjb2RQYXJ0aWRhIDogZC5jb2RQYXJ0aWRhLCBjb2RDYXBpdHVsbzogZC5jb2RDYXBpdHVsb30pIDogZC5jYXBpdHVsbztcbiAgICAgICAgICAgIGQucHJvZ3JhbWEgPSB0aGlzLmRpY3Rpb25hcnkuZ2V0UHJvZ3JhbWEoe2NvZFBhcnRpZGEgOiBkLmNvZFBhcnRpZGEsIGNvZENhcGl0dWxvOiBkLmNvZENhcGl0dWxvLCBjb2RQcm9ncmFtYTogZC5jb2RQcm9ncmFtYX0pID8gdGhpcy5kaWN0aW9uYXJ5LmdldFByb2dyYW1hKHtjb2RQYXJ0aWRhIDogZC5jb2RQYXJ0aWRhLCBjb2RDYXBpdHVsbzogZC5jb2RDYXBpdHVsbywgY29kUHJvZ3JhbWE6IGQuY29kUHJvZ3JhbWF9KSA6IGQucHJvZ3JhbWE7XG4gICAgICAgIH0pXG4gICAgfVxufVxuXG5jbGFzcyBEaWNjaW9uYXJpb1Byb2dyYW1hcyB7XG4gICAgZGljdGlvbmFyeSA9IHt9XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcblxuICAgIH1cblxuICAgIGJ1aWxkRGljdGlvbmFyeShpdGVtcykge1xuICAgICAgICBjb25zdCBpdGVtc0J5UGFydGlkYSA9IF8uZ3JvdXBCeShpdGVtcywgKGQ6IEl0ZW1QcmVzdXB1ZXN0bykgPT4gZC5jb2RQYXJ0aWRhKTtcblxuICAgICAgICBfLmVhY2goaXRlbXNCeVBhcnRpZGEsIChpdGVtc0NhcGl0dWxvOkl0ZW1QcmVzdXB1ZXN0b1tdLCBjb2RQYXJ0aWRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRpY3Rpb25hcnlbY29kUGFydGlkYV0gPSB0aGlzLmRpY3Rpb25hcnlbY29kUGFydGlkYV0gfHwgeyBub21icmU6Xy5maXJzdChpdGVtc0NhcGl0dWxvKS5wYXJ0aWRhLCBjYXBpdHVsb3M6IHt9fTtcblxuICAgICAgICAgICAgY29uc3QgaXRlbXNCeUNhcGl0dWxvID0gXy5ncm91cEJ5KGl0ZW1zQ2FwaXR1bG8sIChkKSA9PiBkLmNvZENhcGl0dWxvKVxuICAgICAgICAgICAgXy5lYWNoKGl0ZW1zQnlDYXBpdHVsbywgKGl0ZW1zUHJvZ3JhbWE6SXRlbVByZXN1cHVlc3RvW10sY29kQ2FwaXR1bG8pICA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaWN0aW9uYXJ5W2NvZFBhcnRpZGFdLmNhcGl0dWxvc1tjb2RDYXBpdHVsb10gPSB0aGlzLmRpY3Rpb25hcnlbY29kUGFydGlkYV0uY2FwaXR1bG9zW2NvZENhcGl0dWxvXSB8fCB7IG5vbWJyZTpfLmZpcnN0KGl0ZW1zUHJvZ3JhbWEpLmNhcGl0dWxvLCBwcm9ncmFtYXM6IHt9fTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zQnlQcm9ncmFtYSA9IF8uZ3JvdXBCeShpdGVtc1Byb2dyYW1hLCAoZCkgPT4gZC5jb2RQcm9ncmFtYSk7XG4gICAgICAgICAgICAgICAgXy5lYWNoKGl0ZW1zQnlQcm9ncmFtYSwgKGl0ZW1zQXNpZ25hY2lvbjpJdGVtUHJlc3VwdWVzdG9bXSwgY29kUHJvZ3JhbWEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaWN0aW9uYXJ5W2NvZFBhcnRpZGFdLmNhcGl0dWxvc1tjb2RDYXBpdHVsb10ucHJvZ3JhbWFzW2NvZFByb2dyYW1hXSA9IHRoaXMuZGljdGlvbmFyeVtjb2RQYXJ0aWRhXS5jYXBpdHVsb3NbY29kQ2FwaXR1bG9dLnByb2dyYW1hc1tjb2RQcm9ncmFtYV0gfHwgeyBub21icmU6Xy5maXJzdChpdGVtc0FzaWduYWNpb24pLnByb2dyYW1hfTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgZ2V0UGFydGlkYShvcHRpb25zOntjb2RQYXJ0aWRhOnN0cmluZ30pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGljdGlvbmFyeVtvcHRpb25zLmNvZFBhcnRpZGFdICYmIHRoaXMuZGljdGlvbmFyeVtvcHRpb25zLmNvZFBhcnRpZGFdLm5vbWJyZTtcbiAgICB9ICAgIFxuICAgIFxuICAgIGdldENhcGl0dWxvKG9wdGlvbnM6e2NvZFBhcnRpZGE6c3RyaW5nLCBjb2RDYXBpdHVsbzpzdHJpbmd9KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpY3Rpb25hcnlbb3B0aW9ucy5jb2RQYXJ0aWRhXSAmJiB0aGlzLmRpY3Rpb25hcnlbb3B0aW9ucy5jb2RQYXJ0aWRhXS5jYXBpdHVsb3Nbb3B0aW9ucy5jb2RDYXBpdHVsb10gJiYgdGhpcy5kaWN0aW9uYXJ5W29wdGlvbnMuY29kUGFydGlkYV0uY2FwaXR1bG9zW29wdGlvbnMuY29kQ2FwaXR1bG9dLm5vbWJyZTtcbiAgICB9ICAgIFxuXG4gICAgZ2V0UHJvZ3JhbWEob3B0aW9uczp7Y29kUGFydGlkYTpzdHJpbmcsIGNvZENhcGl0dWxvOnN0cmluZywgY29kUHJvZ3JhbWE6c3RyaW5nfSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5W29wdGlvbnMuY29kUGFydGlkYV0gJiYgdGhpcy5kaWN0aW9uYXJ5W29wdGlvbnMuY29kUGFydGlkYV0uY2FwaXR1bG9zW29wdGlvbnMuY29kQ2FwaXR1bG9dICAmJiB0aGlzLmRpY3Rpb25hcnlbb3B0aW9ucy5jb2RQYXJ0aWRhXS5jYXBpdHVsb3Nbb3B0aW9ucy5jb2RDYXBpdHVsb10ucHJvZ3JhbWFzW29wdGlvbnMuY29kUHJvZ3JhbWFdICYmIHRoaXMuZGljdGlvbmFyeVtvcHRpb25zLmNvZFBhcnRpZGFdLmNhcGl0dWxvc1tvcHRpb25zLmNvZENhcGl0dWxvXS5wcm9ncmFtYXNbb3B0aW9ucy5jb2RQcm9ncmFtYV0ubm9tYnJlO1xuICAgIH1cblxuXG59XG5cbmNvbnN0IHByZXN1cHVlc3RvSGlzdG9yaWNvID0gbmV3IFByZXN1cHVlc3RvSGlzdG9yaWNvKClcblxubGV0IHByZXN1cHVlc3RvQWxsWWVhcnMgPSAnJztcbl8uZWFjaCh4bWxGaWxlcywgKGQsaSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGQucGVyaW9kbyk7XG5cbiAgICBjb25zdCB4bWwgPSByZWFkVGV4dEZpbGUucmVhZFN5bmMoZC51cmwpO1xuICAgIGxldCBwcmVzdXB1ZXN0byA9IG5ldyBQcmVzdXB1ZXN0b0FudWFsKHhtbCk7ICAgIFxuICAgIGxldCBwcmVzdXB1ZXN0b1RzdiA9IHByZXN1cHVlc3RvLnRzdkZvcm1hdHRlZCgpO1xuICAgIGZzLndyaXRlRmlsZShcbiAgICAgICAgYCR7b3V0RGlyfS9wcmVzdXB1ZXN0b18ke2QucGVyaW9kb30udHh0YCxcbiAgICAgICAgcHJlc3VwdWVzdG9Uc3YsXG4gICAgICAgIGZ1bmN0aW9uIChlcnIpIHsgY29uc29sZS5sb2coZXJyID8gJ0Vycm9yIDonK2VyciA6IGBvayAke2QucGVyaW9kb30udHh0YCkgfVxuICAgICk7XG4gICAgcHJlc3VwdWVzdG9IaXN0b3JpY28uYWRkVFNWKHByZXN1cHVlc3RvVHN2KTtcbn0pO1xuXG5wcmVzdXB1ZXN0b0hpc3Rvcmljby5ub3JtYWxpc2VOYW1lcygpO1xuZnMud3JpdGVGaWxlKFxuICAgIGAke291dERpcn0vcHJlc3VwdWVzdG9fYWxsWWVhcnMudHh0YCxcbiAgICBwcmVzdXB1ZXN0b0hpc3Rvcmljby50c3ZGb3JtYXR0ZWQoKSxcbiAgICBmdW5jdGlvbiAoZXJyKSB7IGNvbnNvbGUubG9nKGVyciA/ICdFcnJvciA6JytlcnIgOiBgb2sgQWxsWWVhcnMudHh0YCkgfVxuKTtcblxuIl0sInNvdXJjZVJvb3QiOiIifQ==
