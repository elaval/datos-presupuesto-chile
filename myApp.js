"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var parseString = require("xml2js");
var readTextFile = require("read-text-file");
var _ = require("lodash");
var d3Format = require("d3-format");
var d3Dsv = require("d3-dsv");
var fs = require("fs");
var formatter3 = d3Format.format('.3f');
var formatter1 = d3Format.format('.1f');
var PresupuestoAnual = (function () {
    function PresupuestoAnual(xml) {
        var _this = this;
        parseString.parseString(xml, function (err, result) {
            _this.pptoCabecera = result.matriz.cabecera;
            _this.pptoCuerpo = result.matriz.cuerpo;
        });
        this.processCuerpo();
        this.itemsCodigosInstituciones = this.processCabecera();
        this.diccionarioInstituciones = this.buildDiccionarioPartidaCapituloPrograma(this.itemsCodigosInstituciones);
        this.periodo = this.buscarPerido();
        this.addNombresYAño();
    }
    PresupuestoAnual.prototype.processCuerpo = function () {
        this.itemsPresupuesto = _.map(this.pptoCuerpo, function (d) {
            return {
                codPartida: d['CodInstit'][0].substring(0, 2),
                codCapitulo: null,
                codPrograma: null,
                partida: null,
                capitulo: null,
                programa: null,
                asigna: d['asigna'][0],
                codInstit: d['CodInstit'][0],
                item: d['item'][0],
                moneda: d['Moneda'][0],
                montoDolar: d['monto_dolar'][0],
                montoPesos: d['monto_pesos'][0],
                nombreNuevo: d['nombre_nuevo'][0].trim(),
                nSecuencial: d['Nsecuencial'][0],
                numGlosa: d['Num_Glosa'][0],
                subti: d['subti[0]'],
                tipoMov: d['t_tipo_mov[0]'],
                periodo: null,
                nombre: null
            };
        });
    };
    /**
     * Cada item de la cabecera incluye el periodo
     *
     * Vamos a verificar que exista sólo uno y lo almacenamos, de lo contrario retornamos el valor -9999
     *
     * @memberof PresupuestoAnual
     */
    PresupuestoAnual.prototype.buscarPerido = function () {
        var periodos = new Set();
        var periodo = null; // Default
        _.each(this.itemsCodigosInstituciones, function (d) {
            periodos.add(d.periodo);
        });
        if (periodos.size === 1) {
            periodo = +periodos.values().next().value;
        }
        return periodo;
    };
    PresupuestoAnual.prototype.processCabecera = function () {
        // console.dir(result);
        var itemsCodigos = _.map(this.pptoCabecera, function (d) {
            var nombre = d['nombre'][0].trim();
            var periodo = d['periodo'][0];
            var partida = d['partida'][0];
            var capitulo = d['capitulo'][0];
            var programa = d['programa'][0];
            var glosa_Programa = d['glosa_Programa'][0];
            var moneda = d['moneda[0]'];
            var record = {
                nombre: nombre,
                periodo: periodo,
                partida: partida,
                capitulo: capitulo,
                programa: programa,
                glosa_Programa: glosa_Programa,
                moneda: moneda
            };
            return record;
        });
        return itemsCodigos;
    };
    PresupuestoAnual.prototype.buildDiccionarioPartidaCapituloPrograma = function (itemsCodigosInstituciones) {
        var diccionario = {};
        // Agrupamos los códigos por partida
        var partidas = _.groupBy(itemsCodigosInstituciones, function (d) {
            return d.partida;
        });
        _.each(partidas, function (items, partida) {
            // Agrupamos los items de cada partida por capítulo
            var capitulos = _.groupBy(items, function (d) {
                return d.capitulo;
            });
            _.each(capitulos, function (items2, capitulo) {
                // Agrupamos los items de cada caspitulo por programas
                var programas = _.groupBy(items2, function (d) {
                    return d.programa;
                });
                _.each(programas, function (items3, programa) {
                    // Si el item tiene capitulo 00 & programa 00, el nombre corresponde a la partida
                    // Si el item tiene programa 00, el nombre corresponde al capitulo
                    // En si capitulo & programa tienen valores, el nombre corresponde al programa
                    _.each(items3, function (d) {
                        // Partida
                        if (capitulo == '00' && programa == '00') {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].nombre = d.nombre;
                            // Capitulo
                        }
                        else if (programa == '00') {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].capitulos[capitulo] = diccionario[partida].capitulos[capitulo] || { nombre: '', programas: {} };
                            diccionario[partida].capitulos[capitulo].nombre = d.nombre;
                            // Programa
                        }
                        else {
                            diccionario[partida] = diccionario[partida] || { nombre: '', capitulos: {} };
                            diccionario[partida].capitulos[capitulo] = diccionario[partida].capitulos[capitulo] || { nombre: '', programas: {} };
                            diccionario[partida].capitulos[capitulo].programas[programa] =
                                diccionario[partida].capitulos[capitulo].programas[programa] || { nombre: '' };
                            diccionario[partida].capitulos[capitulo].programas[programa].nombre = d.nombre;
                        }
                        //console.log(d.partida, d.capitulo, d.programa, d.nombre);
                    });
                });
            });
        });
        return diccionario;
    };
    PresupuestoAnual.prototype.addNombresYAño = function () {
        var _this = this;
        var itemsPpto = _.groupBy(this.itemsPresupuesto, function (d) {
            return d.codInstit;
        });
        _.each(itemsPpto, function (items, codInstit) {
            var codPartida = codInstit.substring(0, 2);
            var codCapitulo = codInstit.substring(2, 4);
            var codPrograma = codInstit.substring(4, 6);
            var partida = _this.diccionarioInstituciones[codPartida];
            var capitulo = partida.capitulos[codCapitulo];
            var programa = capitulo.programas[codPrograma];
            _.each(items, function (d) {
                d.codPartida = codPartida;
                d.codCapitulo = codCapitulo;
                d.codPrograma = codPrograma;
                d.partida = partida.nombre;
                d.capitulo = capitulo.nombre;
                d.programa = programa.nombre;
                d.periodo = _this.periodo;
            });
        });
    };
    PresupuestoAnual.prototype.tsvFormatted = function () {
        return d3Dsv.tsvFormat(this.itemsPresupuesto);
    };
    return PresupuestoAnual;
}());
var PresupuestoHistorico = (function () {
    function PresupuestoHistorico() {
        this.records = [];
    }
    PresupuestoHistorico.prototype.addTSV = function (tsv) {
        var newrecords = d3Dsv.tsvParse(tsv);
        this.records = this.records.concat(newrecords);
    };
    PresupuestoHistorico.prototype.tsvFormatted = function () {
        var tsv = d3Dsv.tsvFormat(this.records);
        return tsv;
    };
    PresupuestoHistorico.prototype.normaliseNames = function () {
        var _this = this;
        var maxPeriod = _.maxBy(this.records, function (d) { return d.periodo; }).periodo;
        var itemsMaxPeriod = _.filter(this.records, function (d) { return d.periodo == maxPeriod; });
        this.dictionary = new DiccionarioProgramas();
        this.dictionary.buildDictionary(itemsMaxPeriod);
        _.each(this.records, function (d, i) {
            console.log('normalise', Math.floor(100 * i / _this.records.length));
            d.partida = _this.dictionary.getPartida(d.codPartida);
        });
    };
    return PresupuestoHistorico;
}());
var DiccionarioProgramas = (function () {
    function DiccionarioProgramas() {
        this.dictionary = {};
    }
    DiccionarioProgramas.prototype.buildDictionary = function (items) {
        var _this = this;
        var itemsByPartida = _.groupBy(items, function (d) { return d.codPartida; });
        _.each(itemsByPartida, function (itemsCapitulo, codPartida) {
            _this.dictionary[codPartida] = _this.dictionary[codPartida] || { nombre: _.first(itemsCapitulo).partida, capitulos: {} };
            var itemsByCapitulo = _.groupBy(itemsCapitulo, function (d) { return d.codCapitulo; });
            _.each(itemsByCapitulo, function (itemsPrograma, codCapitulo) {
                _this.dictionary[codPartida][codCapitulo] = _this.dictionary[codPartida][codCapitulo] || { nombre: _.first(itemsPrograma).capitulo, programas: {} };
                var itemsByPrograma = _.groupBy(itemsPrograma, function (d) { return d.codPrograma; });
                _.each(itemsByPrograma, function (itemsAsignacion, codPrograma) {
                    _this.dictionary[codPartida][codCapitulo][codPrograma] = _this.dictionary[codPartida][codCapitulo][codPrograma] || { nombre: _.first(itemsAsignacion).programa };
                });
            });
        });
    };
    DiccionarioProgramas.prototype.getPartida = function (codPartida) {
        return this.dictionary[codPartida] && this.dictionary[codPartida].nombre;
    };
    return DiccionarioProgramas;
}());
var presupuestoHistorico = new PresupuestoHistorico();
var presupuestoAllYears = '';
_.each(config_1.xmlFiles, function (d, i) {
    console.log(d.periodo);
    var xml = readTextFile.readSync(d.url);
    var presupuesto = new PresupuestoAnual(xml);
    var presupuestoTsv = presupuesto.tsvFormatted();
    fs.writeFile(config_1.outDir + "/presupuesto_" + d.periodo + ".txt", presupuestoTsv, function (err) { console.log(err ? 'Error :' + err : "ok " + d.periodo + ".txt"); });
    presupuestoHistorico.addTSV(presupuestoTsv);
});
presupuestoHistorico.normaliseNames();
fs.writeFile(config_1.outDir + "/presupuesto_allYears.txt", presupuestoHistorico.tsvFormatted(), function (err) { console.log(err ? 'Error :' + err : "ok AllYears.txt"); });

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxHQUFHLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBQyxHQUFHLEdBQUcsUUFBTSxDQUFDLENBQUMsT0FBTyxTQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FDOUUsQ0FBQztJQUNGLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNoRCxDQUFDLENBQUMsQ0FBQztBQUVILG9CQUFvQixDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3RDLEVBQUUsQ0FBQyxTQUFTLENBQ0wsZUFBTSw4QkFBMkIsRUFDcEMsb0JBQW9CLENBQUMsWUFBWSxFQUFFLEVBQ25DLFVBQVUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBQyxHQUFHLEdBQUcsaUJBQWlCLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FDMUUsQ0FBQyIsImZpbGUiOiJteUFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHhtbEZpbGVzLCBvdXREaXIgfSBmcm9tIFwiLi9jb25maWdcIjtpbXBvcnQgKiBhcyBwYXJzZVN0cmluZyBmcm9tICd4bWwyanMnO1xuaW1wb3J0ICogYXMgIHJlYWRUZXh0RmlsZSBmcm9tICdyZWFkLXRleHQtZmlsZSc7XG5pbXBvcnQgKiBhcyAgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgKiBhcyAgd3JpdGVGaWxlIGZyb20gJ3dyaXRlJztcbmltcG9ydCAqIGFzICBkM0Zvcm1hdCBmcm9tICdkMy1mb3JtYXQnO1xuaW1wb3J0ICogYXMgIGQzRHN2IGZyb20gJ2QzLWRzdic7XG5pbXBvcnQgKiBhcyAgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgKiBhcyByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xuXG5cblxuY29uc3QgZm9ybWF0dGVyMyA9IGQzRm9ybWF0LmZvcm1hdCgnLjNmJylcbmNvbnN0IGZvcm1hdHRlcjEgPSBkM0Zvcm1hdC5mb3JtYXQoJy4xZicpXG4gXG5cbmludGVyZmFjZSBJdGVtUHJlc3VwdWVzdG8ge1xuICAgIGNvZFBhcnRpZGE6IHN0cmluZztcbiAgICBjb2RDYXBpdHVsbzogc3RyaW5nO1xuICAgIGNvZFByb2dyYW1hOiBzdHJpbmc7XG4gICAgcGFydGlkYTogc3RyaW5nO1xuICAgIGNhcGl0dWxvOiBzdHJpbmc7XG4gICAgcHJvZ3JhbWE6IHN0cmluZztcbiAgICBhc2lnbmE6IHN0cmluZztcbiAgICBjb2RJbnN0aXQ6IHN0cmluZztcbiAgICBpdGVtOiBzdHJpbmc7XG4gICAgbW9uZWRhOiBzdHJpbmc7XG4gICAgbW9udG9Eb2xhcjogc3RyaW5nO1xuICAgIG1vbnRvUGVzb3M6IHN0cmluZztcbiAgICBub21icmU6IHN0cmluZztcbiAgICBuU2VjdWVuY2lhbDogc3RyaW5nO1xuICAgIG51bUdsb3NhOiBzdHJpbmc7XG4gICAgdGlwb01vdjogc3RyaW5nO1xuICAgIHBlcmlvZG86IG51bWJlcjtcbn0gXG5cblxuY2xhc3MgUHJlc3VwdWVzdG9BbnVhbCB7XG4gICAgcHB0b0NhYmVjZXJhO1xuICAgIHBwdG9DdWVycG87XG4gICAgaXRlbXNQcmVzdXB1ZXN0bzogSXRlbVByZXN1cHVlc3RvW107XG4gICAgaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcztcbiAgICBkaWNjaW9uYXJpb0luc3RpdHVjaW9uZXM7XG4gICAgcGVyaW9kbzogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoeG1sKSB7XG4gICAgICAgIHBhcnNlU3RyaW5nLnBhcnNlU3RyaW5nKHhtbCwgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnBwdG9DYWJlY2VyYSA9IHJlc3VsdC5tYXRyaXouY2FiZWNlcmE7XG4gICAgICAgICAgICB0aGlzLnBwdG9DdWVycG8gPSByZXN1bHQubWF0cml6LmN1ZXJwbztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5wcm9jZXNzQ3VlcnBvKCk7XG4gICAgICAgIHRoaXMuaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcyA9IHRoaXMucHJvY2Vzc0NhYmVjZXJhKCk7XG4gICAgICAgIHRoaXMuZGljY2lvbmFyaW9JbnN0aXR1Y2lvbmVzID0gdGhpcy5idWlsZERpY2Npb25hcmlvUGFydGlkYUNhcGl0dWxvUHJvZ3JhbWEodGhpcy5pdGVtc0NvZGlnb3NJbnN0aXR1Y2lvbmVzKVxuICAgICAgICB0aGlzLnBlcmlvZG8gPSB0aGlzLmJ1c2NhclBlcmlkbygpO1xuICAgICAgICB0aGlzLmFkZE5vbWJyZXNZQcOxbygpO1xuICAgIH1cblxuICAgIHByb2Nlc3NDdWVycG8oKSB7XG4gICAgICAgIHRoaXMuaXRlbXNQcmVzdXB1ZXN0byA9IF8ubWFwKHRoaXMucHB0b0N1ZXJwbywgKGQpID0+IHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIDxJdGVtUHJlc3VwdWVzdG8+IHtcbiAgICAgICAgICAgICAgICBjb2RQYXJ0aWRhOiBkWydDb2RJbnN0aXQnXVswXS5zdWJzdHJpbmcoMCwyKSxcbiAgICAgICAgICAgICAgICBjb2RDYXBpdHVsbzogbnVsbCxcbiAgICAgICAgICAgICAgICBjb2RQcm9ncmFtYTogbnVsbCxcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwYXJ0aWRhOiBudWxsLFxuICAgICAgICAgICAgICAgIGNhcGl0dWxvOiBudWxsLFxuICAgICAgICAgICAgICAgIHByb2dyYW1hOiBudWxsLFxuXG4gICAgICAgICAgICAgICAgYXNpZ25hIDogZFsnYXNpZ25hJ11bMF0sXG4gICAgICAgICAgICAgICAgY29kSW5zdGl0IDogZFsnQ29kSW5zdGl0J11bMF0sXG4gICAgICAgICAgICAgICAgaXRlbSA6IGRbJ2l0ZW0nXVswXSxcbiAgICAgICAgICAgICAgICBtb25lZGEgOiBkWydNb25lZGEnXVswXSxcbiAgICAgICAgICAgICAgICBtb250b0RvbGFyIDogZFsnbW9udG9fZG9sYXInXVswXSxcbiAgICAgICAgICAgICAgICBtb250b1Blc29zIDogZFsnbW9udG9fcGVzb3MnXVswXSxcbiAgICAgICAgICAgICAgICBub21icmVOdWV2byA6IGRbJ25vbWJyZV9udWV2byddWzBdLnRyaW0oKSxcbiAgICAgICAgICAgICAgICBuU2VjdWVuY2lhbCA6IGRbJ05zZWN1ZW5jaWFsJ11bMF0sXG4gICAgICAgICAgICAgICAgbnVtR2xvc2EgOiBkWydOdW1fR2xvc2EnXVswXSxcbiAgICAgICAgICAgICAgICBzdWJ0aSA6IGRbJ3N1YnRpWzBdJ10sXG4gICAgICAgICAgICAgICAgdGlwb01vdiA6IGRbJ3RfdGlwb19tb3ZbMF0nXSxcbiAgICAgICAgICAgICAgICBwZXJpb2RvIDogbnVsbCxcbiAgICAgICAgICAgICAgICBub21icmU6IG51bGxcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWRhIGl0ZW0gZGUgbGEgY2FiZWNlcmEgaW5jbHV5ZSBlbCBwZXJpb2RvXG4gICAgICogXG4gICAgICogVmFtb3MgYSB2ZXJpZmljYXIgcXVlIGV4aXN0YSBzw7NsbyB1bm8geSBsbyBhbG1hY2VuYW1vcywgZGUgbG8gY29udHJhcmlvIHJldG9ybmFtb3MgZWwgdmFsb3IgLTk5OTlcbiAgICAgKiBcbiAgICAgKiBAbWVtYmVyb2YgUHJlc3VwdWVzdG9BbnVhbFxuICAgICAqL1xuICAgIGJ1c2NhclBlcmlkbygpIHtcbiAgICAgICAgY29uc3QgcGVyaW9kb3MgPSBuZXcgU2V0KCk7XG5cbiAgICAgICAgbGV0IHBlcmlvZG8gPSBudWxsOyAvLyBEZWZhdWx0XG5cbiAgICAgICAgXy5lYWNoKHRoaXMuaXRlbXNDb2RpZ29zSW5zdGl0dWNpb25lcywgKGQpID0+IHtcbiAgICAgICAgICAgIHBlcmlvZG9zLmFkZChkLnBlcmlvZG8pXG4gICAgICAgIH0pXG5cbiAgICAgICAgaWYgKHBlcmlvZG9zLnNpemUgPT09IDEpIHtcbiAgICAgICAgICAgIHBlcmlvZG8gPSArcGVyaW9kb3MudmFsdWVzKCkubmV4dCgpLnZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBlcmlvZG87XG5cbiAgICB9XG5cbiAgICBwcm9jZXNzQ2FiZWNlcmEoKSB7XG4gICAgICAgIC8vIGNvbnNvbGUuZGlyKHJlc3VsdCk7XG4gICAgICAgIGNvbnN0IGl0ZW1zQ29kaWdvcyA9IF8ubWFwKHRoaXMucHB0b0NhYmVjZXJhLCAoZCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgbm9tYnJlID0gZFsnbm9tYnJlJ11bMF0udHJpbSgpO1xuICAgICAgICAgICAgY29uc3QgcGVyaW9kbyA9IGRbJ3BlcmlvZG8nXVswXTtcbiAgICAgICAgICAgIGNvbnN0IHBhcnRpZGEgPSBkWydwYXJ0aWRhJ11bMF07XG4gICAgICAgICAgICBjb25zdCBjYXBpdHVsbyA9IGRbJ2NhcGl0dWxvJ11bMF07XG4gICAgICAgICAgICBjb25zdCBwcm9ncmFtYSA9IGRbJ3Byb2dyYW1hJ11bMF07XG4gICAgICAgICAgICBjb25zdCBnbG9zYV9Qcm9ncmFtYSA9IGRbJ2dsb3NhX1Byb2dyYW1hJ11bMF07XG4gICAgICAgICAgICBjb25zdCBtb25lZGEgPSBkWydtb25lZGFbMF0nXTtcblxuICAgICAgICAgICAgY29uc3QgcmVjb3JkID0ge1xuICAgICAgICAgICAgICAgIG5vbWJyZTogbm9tYnJlLCAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHBlcmlvZG86IHBlcmlvZG8sICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwYXJ0aWRhOiBwYXJ0aWRhLCAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY2FwaXR1bG86IGNhcGl0dWxvLCAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb2dyYW1hOiBwcm9ncmFtYSwgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZ2xvc2FfUHJvZ3JhbWE6IGdsb3NhX1Byb2dyYW1hLCAgICAgICBcbiAgICAgICAgICAgICAgICBtb25lZGE6IG1vbmVkYSAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gaXRlbXNDb2RpZ29zO1xuICAgIH1cblxuICAgIGJ1aWxkRGljY2lvbmFyaW9QYXJ0aWRhQ2FwaXR1bG9Qcm9ncmFtYShpdGVtc0NvZGlnb3NJbnN0aXR1Y2lvbmVzKSB7XG4gICAgICAgIGNvbnN0IGRpY2Npb25hcmlvID0ge307XG5cbiAgICAgICAgLy8gQWdydXBhbW9zIGxvcyBjw7NkaWdvcyBwb3IgcGFydGlkYVxuICAgICAgICBjb25zdCBwYXJ0aWRhcyA9IF8uZ3JvdXBCeShpdGVtc0NvZGlnb3NJbnN0aXR1Y2lvbmVzLCAoZDpJdGVtUHJlc3VwdWVzdG8pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkLnBhcnRpZGE7XG4gICAgICAgIH0pXG5cbiAgICAgICAgXy5lYWNoKHBhcnRpZGFzLCAoaXRlbXMsIHBhcnRpZGEpID0+IHtcblxuICAgICAgICAgICAgLy8gQWdydXBhbW9zIGxvcyBpdGVtcyBkZSBjYWRhIHBhcnRpZGEgcG9yIGNhcMOtdHVsb1xuICAgICAgICAgICAgY29uc3QgY2FwaXR1bG9zID0gXy5ncm91cEJ5KGl0ZW1zLCAoZCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBkLmNhcGl0dWxvO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIF8uZWFjaChjYXBpdHVsb3MsIChpdGVtczIsIGNhcGl0dWxvKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBBZ3J1cGFtb3MgbG9zIGl0ZW1zIGRlIGNhZGEgY2FzcGl0dWxvIHBvciBwcm9ncmFtYXNcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmFtYXMgPSBfLmdyb3VwQnkoaXRlbXMyLCAoZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5wcm9ncmFtYTtcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgXy5lYWNoKHByb2dyYW1hcywgKGl0ZW1zMywgcHJvZ3JhbWEpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBTaSBlbCBpdGVtIHRpZW5lIGNhcGl0dWxvIDAwICYgcHJvZ3JhbWEgMDAsIGVsIG5vbWJyZSBjb3JyZXNwb25kZSBhIGxhIHBhcnRpZGFcbiAgICAgICAgICAgICAgICAgICAgLy8gU2kgZWwgaXRlbSB0aWVuZSBwcm9ncmFtYSAwMCwgZWwgbm9tYnJlIGNvcnJlc3BvbmRlIGFsIGNhcGl0dWxvXG4gICAgICAgICAgICAgICAgICAgIC8vIEVuIHNpIGNhcGl0dWxvICYgcHJvZ3JhbWEgdGllbmVuIHZhbG9yZXMsIGVsIG5vbWJyZSBjb3JyZXNwb25kZSBhbCBwcm9ncmFtYVxuICAgICAgICAgICAgICAgICAgICBfLmVhY2goaXRlbXMzLCAoZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUGFydGlkYVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhcGl0dWxvID09ICcwMCcgJiYgcHJvZ3JhbWEgPT0gJzAwJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdID0gZGljY2lvbmFyaW9bcGFydGlkYV0gfHwge25vbWJyZTonJywgY2FwaXR1bG9zOnt9fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5ub21icmUgPSBkLm5vbWJyZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhcGl0dWxvXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb2dyYW1hID09ICcwMCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXSA9IGRpY2Npb25hcmlvW3BhcnRpZGFdIHx8IHtub21icmU6JycsIGNhcGl0dWxvczp7fX07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGljY2lvbmFyaW9bcGFydGlkYV0uY2FwaXR1bG9zW2NhcGl0dWxvXSA9IGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10gfHwge25vbWJyZTonJywgcHJvZ3JhbWFzOiB7fX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dLm5vbWJyZSA9IGQubm9tYnJlXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByb2dyYW1hXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdID0gZGljY2lvbmFyaW9bcGFydGlkYV0gfHwge25vbWJyZTonJywgY2FwaXR1bG9zOnt9fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWNjaW9uYXJpb1twYXJ0aWRhXS5jYXBpdHVsb3NbY2FwaXR1bG9dID0gZGljY2lvbmFyaW9bcGFydGlkYV0uY2FwaXR1bG9zW2NhcGl0dWxvXSB8fCB7bm9tYnJlOicnLCBwcm9ncmFtYXM6IHt9fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10ucHJvZ3JhbWFzW3Byb2dyYW1hXSA9IFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10ucHJvZ3JhbWFzW3Byb2dyYW1hXSB8fCB7bm9tYnJlOicnfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2Npb25hcmlvW3BhcnRpZGFdLmNhcGl0dWxvc1tjYXBpdHVsb10ucHJvZ3JhbWFzW3Byb2dyYW1hXS5ub21icmUgPSBkLm5vbWJyZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGQucGFydGlkYSwgZC5jYXBpdHVsbywgZC5wcm9ncmFtYSwgZC5ub21icmUpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSkgICBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBkaWNjaW9uYXJpbztcbiAgICB9XG5cbiAgICBhZGROb21icmVzWUHDsW8oKSB7XG5cbiAgICAgICAgY29uc3QgaXRlbXNQcHRvID0gXy5ncm91cEJ5KHRoaXMuaXRlbXNQcmVzdXB1ZXN0bywgKGQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkLmNvZEluc3RpdDtcbiAgICAgICAgfSlcblxuICAgICAgICBfLmVhY2goaXRlbXNQcHRvICwgKGl0ZW1zLCBjb2RJbnN0aXQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZFBhcnRpZGE9IGNvZEluc3RpdC5zdWJzdHJpbmcoMCwyKTtcbiAgICAgICAgICAgIGNvbnN0IGNvZENhcGl0dWxvPSBjb2RJbnN0aXQuc3Vic3RyaW5nKDIsNCk7XG4gICAgICAgICAgICBjb25zdCBjb2RQcm9ncmFtYT0gY29kSW5zdGl0LnN1YnN0cmluZyg0LDYpO1xuXG4gICAgICAgICAgICBjb25zdCBwYXJ0aWRhID0gdGhpcy5kaWNjaW9uYXJpb0luc3RpdHVjaW9uZXNbY29kUGFydGlkYV07XG4gICAgICAgICAgICBjb25zdCBjYXBpdHVsbyA9IHBhcnRpZGEuY2FwaXR1bG9zW2NvZENhcGl0dWxvXTtcbiAgICAgICAgICAgIGNvbnN0IHByb2dyYW1hID0gY2FwaXR1bG8ucHJvZ3JhbWFzW2NvZFByb2dyYW1hXTtcblxuICAgICAgICAgICAgXy5lYWNoKGl0ZW1zLCAoZCkgPT4ge1xuICAgICAgICAgICAgICAgIGQuY29kUGFydGlkYSA9IGNvZFBhcnRpZGE7XG4gICAgICAgICAgICAgICAgZC5jb2RDYXBpdHVsbyA9IGNvZENhcGl0dWxvO1xuICAgICAgICAgICAgICAgIGQuY29kUHJvZ3JhbWEgPSBjb2RQcm9ncmFtYTsgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBkLnBhcnRpZGEgPSBwYXJ0aWRhLm5vbWJyZTtcbiAgICAgICAgICAgICAgICBkLmNhcGl0dWxvID0gY2FwaXR1bG8ubm9tYnJlO1xuICAgICAgICAgICAgICAgIGQucHJvZ3JhbWEgPSBwcm9ncmFtYS5ub21icmU7ICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZC5wZXJpb2RvID0gdGhpcy5wZXJpb2RvO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICB0c3ZGb3JtYXR0ZWQoKSB7XG4gICAgICAgIHJldHVybiBkM0Rzdi50c3ZGb3JtYXQodGhpcy5pdGVtc1ByZXN1cHVlc3RvKTtcbiAgICB9XG59XG5cbmNsYXNzIFByZXN1cHVlc3RvSGlzdG9yaWNvIHtcbiAgICByZWNvcmRzOiBJdGVtUHJlc3VwdWVzdG9bXSA9IFtdO1xuICAgIGRpY3Rpb25hcnk6IERpY2Npb25hcmlvUHJvZ3JhbWFzO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICB9XG5cbiAgICBhZGRUU1YodHN2KSB7XG4gICAgICAgIGxldCBuZXdyZWNvcmRzOiBhbnlbXSA9IDxhbnlbXT4gZDNEc3YudHN2UGFyc2UodHN2KTtcbiAgICAgICAgdGhpcy5yZWNvcmRzID0gdGhpcy5yZWNvcmRzLmNvbmNhdChuZXdyZWNvcmRzKTtcbiAgICB9XG5cbiAgICB0c3ZGb3JtYXR0ZWQoKSB7XG4gICAgICAgIGxldCB0c3YgPSBkM0Rzdi50c3ZGb3JtYXQodGhpcy5yZWNvcmRzKTtcbiAgICAgICAgcmV0dXJuIHRzdjtcbiAgICB9XG5cbiAgICBub3JtYWxpc2VOYW1lcygpIHtcbiAgICAgICAgY29uc3QgbWF4UGVyaW9kID0gXy5tYXhCeSh0aGlzLnJlY29yZHMsIChkOkl0ZW1QcmVzdXB1ZXN0bykgPT4gZC5wZXJpb2RvKS5wZXJpb2RvO1xuICAgICAgICBjb25zdCBpdGVtc01heFBlcmlvZCA9IF8uZmlsdGVyKHRoaXMucmVjb3JkcywgKGQpID0+IGQucGVyaW9kbyA9PSBtYXhQZXJpb2QpO1xuXG4gICAgICAgIHRoaXMuZGljdGlvbmFyeSA9IG5ldyBEaWNjaW9uYXJpb1Byb2dyYW1hcygpO1xuICAgICAgICB0aGlzLmRpY3Rpb25hcnkuYnVpbGREaWN0aW9uYXJ5KGl0ZW1zTWF4UGVyaW9kKTtcblxuICAgICAgICBfLmVhY2godGhpcy5yZWNvcmRzLCAoZCxpKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnbm9ybWFsaXNlJywgTWF0aC5mbG9vcigxMDAqaS90aGlzLnJlY29yZHMubGVuZ3RoKSk7XG4gICAgICAgICAgICBkLnBhcnRpZGEgPSB0aGlzLmRpY3Rpb25hcnkuZ2V0UGFydGlkYShkLmNvZFBhcnRpZGEpO1xuICAgICAgICB9KVxuICAgIH1cbn1cblxuY2xhc3MgRGljY2lvbmFyaW9Qcm9ncmFtYXMge1xuICAgIGRpY3Rpb25hcnkgPSB7fVxuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICB9XG5cbiAgICBidWlsZERpY3Rpb25hcnkoaXRlbXMpIHtcbiAgICAgICAgY29uc3QgaXRlbXNCeVBhcnRpZGEgPSBfLmdyb3VwQnkoaXRlbXMsIChkOiBJdGVtUHJlc3VwdWVzdG8pID0+IGQuY29kUGFydGlkYSk7XG5cbiAgICAgICAgXy5lYWNoKGl0ZW1zQnlQYXJ0aWRhLCAoaXRlbXNDYXBpdHVsbzpJdGVtUHJlc3VwdWVzdG9bXSwgY29kUGFydGlkYSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kaWN0aW9uYXJ5W2NvZFBhcnRpZGFdID0gdGhpcy5kaWN0aW9uYXJ5W2NvZFBhcnRpZGFdIHx8IHsgbm9tYnJlOl8uZmlyc3QoaXRlbXNDYXBpdHVsbykucGFydGlkYSwgY2FwaXR1bG9zOiB7fX07XG5cbiAgICAgICAgICAgIGNvbnN0IGl0ZW1zQnlDYXBpdHVsbyA9IF8uZ3JvdXBCeShpdGVtc0NhcGl0dWxvLCAoZCkgPT4gZC5jb2RDYXBpdHVsbylcbiAgICAgICAgICAgIF8uZWFjaChpdGVtc0J5Q2FwaXR1bG8sIChpdGVtc1Byb2dyYW1hOkl0ZW1QcmVzdXB1ZXN0b1tdLGNvZENhcGl0dWxvKSAgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZGljdGlvbmFyeVtjb2RQYXJ0aWRhXVtjb2RDYXBpdHVsb10gPSB0aGlzLmRpY3Rpb25hcnlbY29kUGFydGlkYV1bY29kQ2FwaXR1bG9dIHx8IHsgbm9tYnJlOl8uZmlyc3QoaXRlbXNQcm9ncmFtYSkuY2FwaXR1bG8sIHByb2dyYW1hczoge319O1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbXNCeVByb2dyYW1hID0gXy5ncm91cEJ5KGl0ZW1zUHJvZ3JhbWEsIChkKSA9PiBkLmNvZFByb2dyYW1hKTtcbiAgICAgICAgICAgICAgICBfLmVhY2goaXRlbXNCeVByb2dyYW1hLCAoaXRlbXNBc2lnbmFjaW9uOkl0ZW1QcmVzdXB1ZXN0b1tdLCBjb2RQcm9ncmFtYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpY3Rpb25hcnlbY29kUGFydGlkYV1bY29kQ2FwaXR1bG9dW2NvZFByb2dyYW1hXSA9IHRoaXMuZGljdGlvbmFyeVtjb2RQYXJ0aWRhXVtjb2RDYXBpdHVsb11bY29kUHJvZ3JhbWFdIHx8IHsgbm9tYnJlOl8uZmlyc3QoaXRlbXNBc2lnbmFjaW9uKS5wcm9ncmFtYX07XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIGdldFBhcnRpZGEoY29kUGFydGlkYSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5W2NvZFBhcnRpZGFdICYmIHRoaXMuZGljdGlvbmFyeVtjb2RQYXJ0aWRhXS5ub21icmU7XG4gICAgfVxuXG5cbn1cblxuY29uc3QgcHJlc3VwdWVzdG9IaXN0b3JpY28gPSBuZXcgUHJlc3VwdWVzdG9IaXN0b3JpY28oKVxuXG5sZXQgcHJlc3VwdWVzdG9BbGxZZWFycyA9ICcnO1xuXy5lYWNoKHhtbEZpbGVzLCAoZCxpKSA9PiB7XG4gICAgY29uc29sZS5sb2coZC5wZXJpb2RvKTtcblxuICAgIGNvbnN0IHhtbCA9IHJlYWRUZXh0RmlsZS5yZWFkU3luYyhkLnVybCk7XG4gICAgbGV0IHByZXN1cHVlc3RvID0gbmV3IFByZXN1cHVlc3RvQW51YWwoeG1sKTsgICAgXG4gICAgbGV0IHByZXN1cHVlc3RvVHN2ID0gcHJlc3VwdWVzdG8udHN2Rm9ybWF0dGVkKCk7XG4gICAgZnMud3JpdGVGaWxlKFxuICAgICAgICBgJHtvdXREaXJ9L3ByZXN1cHVlc3RvXyR7ZC5wZXJpb2RvfS50eHRgLFxuICAgICAgICBwcmVzdXB1ZXN0b1RzdixcbiAgICAgICAgZnVuY3Rpb24gKGVycikgeyBjb25zb2xlLmxvZyhlcnIgPyAnRXJyb3IgOicrZXJyIDogYG9rICR7ZC5wZXJpb2RvfS50eHRgKSB9XG4gICAgKTtcbiAgICBwcmVzdXB1ZXN0b0hpc3Rvcmljby5hZGRUU1YocHJlc3VwdWVzdG9Uc3YpO1xufSk7XG5cbnByZXN1cHVlc3RvSGlzdG9yaWNvLm5vcm1hbGlzZU5hbWVzKCk7XG5mcy53cml0ZUZpbGUoXG4gICAgYCR7b3V0RGlyfS9wcmVzdXB1ZXN0b19hbGxZZWFycy50eHRgLFxuICAgIHByZXN1cHVlc3RvSGlzdG9yaWNvLnRzdkZvcm1hdHRlZCgpLFxuICAgIGZ1bmN0aW9uIChlcnIpIHsgY29uc29sZS5sb2coZXJyID8gJ0Vycm9yIDonK2VyciA6IGBvayBBbGxZZWFycy50eHRgKSB9XG4pO1xuXG4iXSwic291cmNlUm9vdCI6IiJ9
